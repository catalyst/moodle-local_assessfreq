/**
 * Javascript for report card display and processing.
 *
 * @package    local_assessfreq
 * @copyright  2020 Matt Porritt <mattp@catalyst-au.net>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_assessfreq/form_modal",["core/str","core/modal_factory","core/fragment","core/ajax"],(function(Str,ModalFactory,Fragment,Ajax){var contextid,modalObj,callback,FormModal={},resetOptions=[];const spinner='<p class="text-center"><i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i></p>',observerConfig={attributes:!0,childList:!1,subtree:!0},observer=new MutationObserver((function(mutationsList){for(let i=0;i<mutationsList.length;i++){let element=mutationsList[i].target;if("span"===element.tagName.toLowerCase()&&element.classList.contains("badge")){element.addEventListener("click",updateModalBody),document.getElementById("id_courses").dataset.course=element.dataset.value,document.getElementById("id_quiz").value=-1,Ajax.call([{methodname:"local_assessfreq_get_quizzes",args:{query:mutationsList[i].target.dataset.value}}])[0].done((response=>{let quizArray=JSON.parse(response),selectElement=document.getElementById("id_quiz"),selectElementLength=selectElement.options.length;null!==document.getElementById("noquizwarning")&&document.getElementById("noquizwarning").remove();for(let j=selectElementLength-1;j>=0;j--)selectElement.options[j]=null;if(quizArray.length>0){for(let k=0;k<quizArray.length;k++){let opt=quizArray[k],el=document.createElement("option");el.textContent=opt.name,el.value=opt.id,selectElement.appendChild(el)}selectElement.removeAttribute("disabled"),null!==document.getElementById("noquizwarning")&&document.getElementById("noquizwarning").remove()}else resetOptions.forEach((option=>{selectElement.appendChild(option)})),document.getElementById("id_quiz").value=0,selectElement.disabled=!0})).fail((()=>{Notification.exception(new Error("Failed to get quizzes"))}));break}}})),updateModalBody=function(formdata){void 0===formdata&&(formdata={});let params={jsonformdata:JSON.stringify(formdata)};new Promise(((resolve,reject)=>{Str.get_strings([{key:"selectcourse",component:"local_assessfreq"},{key:"loadingquiz",component:"local_assessfreq"}]).catch((()=>{reject(new Error("Failed to load strings"))})).then((stringReturn=>{for(let i=0;i<stringReturn.length;i++){let el=document.createElement("option");el.textContent=stringReturn[i],el.value=0-i,resetOptions.push(el)}resolve()}))})).then((()=>{Str.get_string("searchquiz","local_assessfreq").then((title=>{modalObj.setTitle(title),modalObj.setBody(Fragment.loadFragment("local_assessfreq","new_base_form",contextid,params));let modalContainer=document.querySelectorAll('[data-region*="modal-container"]')[0];observer.observe(modalContainer,observerConfig)}))}))},processModalForm=function(e){e.preventDefault();let quizElement=document.getElementById("id_quiz"),quizId=quizElement.options[quizElement.selectedIndex].value,courseId=document.getElementById("id_courses").dataset.course;void 0===courseId||quizId<1?null===document.getElementById("noquizwarning")&&Str.get_string("noquizselected","local_assessfreq").then((warning=>{let element=document.createElement("div");element.innerHTML=warning,element.id="noquizwarning",element.classList.add("alert","alert-danger"),modalObj.getBody().prepend(element)})):(modalObj.hide(),modalObj.setBody(""),observer.disconnect(),callback(quizId,courseId))},displayModalForm=function(){updateModalBody(),modalObj.show()};return FormModal.init=function(context,processDashboard){contextid=context,callback=processDashboard,Str.get_string("loading","local_assessfreq").then((title=>{ModalFactory.create({type:ModalFactory.types.DEFAULT,title:title,body:spinner,large:!0}).done((modal=>{(modalObj=modal).getRoot().on("click","#id_submitbutton",processModalForm),modalObj.getRoot().on("click","#id_cancel",(e=>{e.preventDefault(),modalObj.setBody(spinner),modalObj.hide()}))}))})),document.getElementById("local-assessfreq-find-quiz").addEventListener("click",displayModalForm)},FormModal}));

//# sourceMappingURL=form_modal.min.js.map