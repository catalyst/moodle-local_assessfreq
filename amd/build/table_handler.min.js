define("local_assessfreq/table_handler",["exports","core/ajax","core/fragment","core/notification","core/templates","local_assessfreq/debouncer","local_assessfreq/override_modal","local_assessfreq/user_preferences"],(function(_exports,_ajax,_fragment,_notification,_templates,Debouncer,_override_modal,UserPreference){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Table handler JS module.
   *
   * @module     local_assessfreq/table_handler
   * @package    local_assessfreq
   * @copyright  2020 Guillermo Gomez <guillermogomez@catalyst-au.net>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */let cardElement,contextId,elementId,fragmentValue,hoursFilter;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.tableSortButtonAction=_exports.tableSearchRowSet=_exports.tableSearchReset=_exports.tableSearch=_exports.init=_exports.getTable=void 0,_ajax=_interopRequireDefault(_ajax),_fragment=_interopRequireDefault(_fragment),_notification=_interopRequireDefault(_notification),_templates=_interopRequireDefault(_templates),Debouncer=_interopRequireWildcard(Debouncer),_override_modal=_interopRequireDefault(_override_modal),UserPreference=_interopRequireWildcard(UserPreference);let rowPreference,sortValue,searchElement,id,methodName,quizId=0,overridden=!1;const getTable=function(quiz){let hours=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,sortValueTable=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,page=arguments.length>3?arguments[3]:void 0;void 0!==page&&!0!==overridden||(page=0),overridden=!1;let search=document.getElementById(searchElement).value.trim(),tableElement=document.getElementById(elementId),spinner=tableElement.getElementsByClassName("overlay-icon-container")[0],tableBody=tableElement.getElementsByClassName("table-body")[0],values={search:search,page:page};if(quiz>0&&(quizId=quiz,values.quiz=quizId),hours&&(hoursFilter=hours,values.hoursahead=hoursFilter[0],values.hoursbehind=hoursFilter[1]),sortValueTable){sortValue=sortValueTable;let sortArray=sortValue.split("_"),sortOn=sortArray[0],direction=sortArray[1];values.sorton=sortOn,values.direction=direction}let params={data:JSON.stringify(values)};spinner.classList.remove("hide"),_fragment.default.loadFragment("local_assessfreq",fragmentValue,contextId,params).done(((response,js)=>{tableBody.innerHTML=response,js&&_templates.default.runTemplateJS(js),spinner.classList.add("hide"),tableEventListeners()})).fail((()=>{_notification.default.exception(new Error("Failed to update table."))}))};_exports.getTable=getTable;const debounceTable=Debouncer.debouncer((()=>{getTable(quizId,hoursFilter,sortValue)}),750),tableSort=event=>{event.preventDefault();let sortArray={};const linkUrl=new URL(event.target.closest("a").href),targetSortBy=linkUrl.searchParams.get("tsort");let targetSortOrder=linkUrl.searchParams.get("tdir");""===targetSortOrder&&(targetSortOrder="4"),sortArray[targetSortBy]=targetSortOrder,_ajax.default.call([{methodname:methodName,args:{tableid:id,preference:"sortby",values:JSON.stringify(sortArray)}}])[0].then((()=>{getTable(quizId,hoursFilter,sortValue)}))},tableHide=event=>{event.preventDefault();let hideArray={};const linkUrl=new URL(event.target.closest("a").href),links=document.getElementById(elementId).querySelectorAll("a");let targetAction,targetColumn,action,column;-1!==linkUrl.search.indexOf("thide")?(targetAction="hide",targetColumn=linkUrl.searchParams.get("thide")):(targetAction="show",targetColumn=linkUrl.searchParams.get("tshow"));for(let i=0;i<links.length;i++){let hideLinkUrl=new URL(links[i].href);-1!==hideLinkUrl.search.indexOf("thide")?(action="hide",column=hideLinkUrl.searchParams.get("thide")):(action="show",column=hideLinkUrl.searchParams.get("tshow")),"show"===action&&(hideArray[column]=1)}hideArray[targetColumn]="hide"===targetAction?1:0,_ajax.default.call([{methodname:methodName,args:{tableid:id,preference:"collapse",values:JSON.stringify(hideArray)}}])[0].then((()=>{getTable(quizId,hoursFilter,sortValue)}))},tableReset=event=>{event.preventDefault(),_ajax.default.call([{methodname:methodName,args:{tableid:id,preference:"reset",values:JSON.stringify({})}}])[0].then((()=>{getTable(quizId,hoursFilter,sortValue)}))};_exports.tableSearch=event=>{if("Meta"===event.key||event.ctrlKey)return!1;(0===event.target.value.length||event.target.value.length>2)&&debounceTable()};_exports.tableSearchReset=()=>{let tableSearchInputElement=document.getElementById(searchElement);tableSearchInputElement.value="",tableSearchInputElement.focus(),getTable(quizId,hoursFilter,sortValue)};_exports.tableSearchRowSet=event=>{if(event.preventDefault(),"a"===event.target.tagName.toLowerCase()){let rows=event.target.dataset.metric;UserPreference.setUserPreference(rowPreference,rows).then((()=>{getTable(quizId,hoursFilter,sortValue)})).fail((()=>{_notification.default.exception(new Error("Failed to update user preference: rows"))}))}};const tableNav=event=>{event.preventDefault();const page=new URL(event.target.closest("a").href).searchParams.get("page");page&&getTable(quizId,hoursFilter,sortValue,page)};_exports.tableSortButtonAction=event=>{event.preventDefault();var element=event.target;if("a"===element.tagName.toLowerCase()&&element.dataset.sort!==sortValue){sortValue=element.dataset.sort;let links=element.parentNode.getElementsByTagName("a");for(let i=0;i<links.length;i++)links[i].classList.remove("active");element.classList.add("active"),UserPreference.setUserPreference("local_assessfreq_quiz_table_inprogress_sort_preference",sortValue),debounceTable()}};const tableEventListeners=()=>{const tableElement=document.getElementById(elementId);let tableNavElement;if(cardElement){const tableCardElement=document.getElementById(cardElement),links=tableElement.querySelectorAll("a"),resetLink=tableElement.getElementsByClassName("resettable"),overrideLinks=tableElement.getElementsByClassName("action-icon override"),disabledLinks=tableElement.getElementsByClassName("action-icon disabled");tableNavElement=tableCardElement.querySelectorAll("nav");for(let i=0;i<links.length;i++){let linkUrl=new URL(links[i].href);-1!==linkUrl.search.indexOf("thide")||-1!==linkUrl.search.indexOf("tshow")?links[i].addEventListener("click",tableHide):-1!==linkUrl.search.indexOf("tsort")&&links[i].addEventListener("click",tableSort)}resetLink.length>0&&resetLink[0].addEventListener("click",tableReset);for(let i=0;i<overrideLinks.length;i++)overrideLinks[i].addEventListener("click",triggerOverrideModal);for(let i=0;i<disabledLinks.length;i++)disabledLinks[i].addEventListener("click",(event=>{event.preventDefault()}))}else tableNavElement=tableElement.querySelectorAll("nav");tableNavElement.forEach((navElement=>{navElement.addEventListener("click",tableNav)}))},triggerOverrideModal=event=>{event.preventDefault();let userid=event.target.closest("a").id.substring(25);if(userid.includes("-")){let elements=userid.split("-");quizId=elements.pop(),userid=elements.pop()}_override_modal.default.displayModalForm(quizId,userid,hoursFilter)};_exports.init=function(quiz,context,tableCardElement,tableElementId,tableFragmentValue,tableRowPreference,tableSearchElement){let tableId=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,tableMethodName=arguments.length>8&&void 0!==arguments[8]?arguments[8]:null;quizId=quiz,contextId=context,cardElement=tableCardElement,elementId=tableElementId,fragmentValue=tableFragmentValue,rowPreference=tableRowPreference,searchElement=tableSearchElement,id=tableId,methodName=tableMethodName}}));

//# sourceMappingURL=table_handler.min.js.map